# ğŸ›¡ï¸ å®‰å…¨ãªç”»åƒçµ±åˆã‚·ã‚¹ãƒ†ãƒ 

## æ¦‚è¦

ContentFlowã§ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ç”»åƒã‚’å®‰å…¨ã«Sanityã«çµ±åˆã™ã‚‹ãŸã‚ã®äºˆé˜²ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚é‡è¤‡ç”»åƒã®å•é¡Œã‚’äº‹å‰ã«æ¤œå‡ºã—ã€é©åˆ‡ãªå¯¾å‡¦æ³•ã‚’é¸æŠã§ãã¾ã™ã€‚

## ğŸš¨ å¾“æ¥ã®å•é¡Œ

- **é‡è¤‡ç”»åƒ**: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»åƒã¨æœ¬æ–‡å†…ç”»åƒã®é‡è¤‡è¡¨ç¤º
- **ãƒ‡ãƒ¼ã‚¿ç ´æãƒªã‚¹ã‚¯**: æ—¢å­˜è¨˜äº‹ã®æ„å›³ã—ãªã„ä¸Šæ›¸ã
- **æ‰‹å‹•ç¢ºèªä¸è¶³**: æ—¢å­˜ç”»åƒçŠ¶æ³ã®è¦‹è½ã¨ã—
- **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—**: å¤±æ•—æ™‚ã®å¾©æ—§å›°é›£

## âœ… è§£æ±ºã•ã‚ŒãŸæ©Ÿèƒ½

### 1. äº‹å‰å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
- æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»åƒæ¤œå‡º
- æœ¬æ–‡å†…ç”»åƒã®å­˜åœ¨ç¢ºèª
- é‡è¤‡ãƒªã‚¹ã‚¯ã®è‡ªå‹•è©•ä¾¡
- è©³ç´°ãªç¾çŠ¶ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º

### 2. å¯¾å‡¦æ³•é¸æŠã‚·ã‚¹ãƒ†ãƒ 
```
âš ï¸ ç”»åƒè¡çªãƒªã‚¹ã‚¯ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼

ğŸ¯ é¸æŠè‚¢:
  1. replace - æ—¢å­˜ç”»åƒã‚’æ–°ç”»åƒã§ç½®æ›
  2. skip - æ—¢å­˜ç”»åƒã‚’ä¿æŒã€çµ±åˆã‚’ã‚¹ã‚­ãƒƒãƒ—  
  3. merge - æ—¢å­˜ç”»åƒã‚’ä¿æŒã€æ–°ç”»åƒã‚’è¿½åŠ ï¼ˆé‡è¤‡ãƒªã‚¹ã‚¯ï¼‰
  4. cancel - çµ±åˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

é¸æŠã—ã¦ãã ã•ã„ (1-4):
```

### 3. è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- çµ±åˆå‰ã®è¨˜äº‹çŠ¶æ…‹ã‚’è‡ªå‹•ä¿å­˜
- `./backups/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ—¥æ™‚ä»˜ãã§ä¿å­˜
- å¤±æ•—æ™‚ã®è¿…é€Ÿãªå¾©æ—§ãŒå¯èƒ½

### 4. åŒ…æ‹¬çš„ãƒ­ã‚°
- è©³ç´°ãªå®Ÿè¡ŒçŠ¶æ³ã®è¡¨ç¤º
- ã‚¨ãƒ©ãƒ¼åŸå› ã®æ˜ç¢ºåŒ–
- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å……å®Ÿ

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬çš„ãªä½¿ç”¨æ³•

```bash
# å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ä»˜ãã§å®Ÿè¡Œ
node scripts/integrate-current-article-safe.js

# å¼·åˆ¶å®Ÿè¡Œï¼ˆæ—¢å­˜ç”»åƒãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
node scripts/integrate-current-article-safe.js --force

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
node scripts/integrate-current-article-safe.js --help
```

### å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

1. **è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢**: æœ€æ–°ã®è¨˜äº‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•æ¤œå‡º
2. **Sanityè¨˜äº‹æ¤œç´¢**: ã‚¹ãƒ©ãƒƒã‚°ãƒ™ãƒ¼ã‚¹ã§å¯¾å¿œè¨˜äº‹ã‚’ç‰¹å®š
3. **ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º**: è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®æœ€æ–°ç‰ˆã‚’é¸æŠ
4. **å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯**: æ—¢å­˜ç”»åƒçŠ¶æ³ã®è©³ç´°åˆ†æ
5. **å¯¾å‡¦æ³•é¸æŠ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹çµ±åˆæ–¹é‡ã®æ±ºå®š
6. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ**: ç¾åœ¨ã®è¨˜äº‹çŠ¶æ…‹ã‚’ä¿å­˜
7. **ç”»åƒçµ±åˆå®Ÿè¡Œ**: é¸æŠã•ã‚ŒãŸæ–¹é‡ã§å®‰å…¨ã«çµ±åˆ
8. **çµæœå ±å‘Š**: çµ±åˆçµæœã¨æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æç¤º

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
ContentFlow/sanity-edition/
â”œâ”€â”€ safe-image-integration.js           # ğŸ›¡ï¸ äºˆé˜²ãƒ­ã‚¸ãƒƒã‚¯æœ¬ä½“
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ integrate-current-article-safe.js # ğŸ”§ å®‰å…¨çµ±åˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ backups/                           # ğŸ’¾ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜å…ˆ
â”œâ”€â”€ check-duplicate-images.js          # ğŸ” äº‹å¾Œè¨ºæ–­ãƒ„ãƒ¼ãƒ«
â”œâ”€â”€ remove-duplicate-images.js         # ğŸ§¹ äº‹å¾Œä¿®å¾©ãƒ„ãƒ¼ãƒ«
â””â”€â”€ SAFE_IMAGE_INTEGRATION.md          # ğŸ“– ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

## ğŸ¯ äºˆé˜²ãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°

### checkExistingImages() é–¢æ•°
```javascript
// æ—¢å­˜ç”»åƒçŠ¶æ³ã®åŒ…æ‹¬çš„ãƒã‚§ãƒƒã‚¯
const imageStatus = await checkExistingImages(documentId);

// æˆ»ã‚Šå€¤:
{
  post: {...},           // è¨˜äº‹ãƒ‡ãƒ¼ã‚¿
  hasFieldImages: true,  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»åƒã®æœ‰ç„¡
  hasBodyImages: false,  // æœ¬æ–‡å†…ç”»åƒã®æœ‰ç„¡ 
  bodyImageCount: 0,     // æœ¬æ–‡å†…ç”»åƒæ•°
  bodyImageIds: [...],   // æœ¬æ–‡å†…ç”»åƒIDä¸€è¦§
  fieldImages: {...}     // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ‰ç„¡è©³ç´°
}
```

### safeImageIntegration() é–¢æ•°
```javascript
// å®‰å…¨ãªçµ±åˆå‡¦ç†ã®å®Ÿè¡Œ
const result = await safeImageIntegration(
  sessionId,    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
  documentId,   // Sanityè¨˜äº‹ID
  slug,         // è¨˜äº‹ã‚¹ãƒ©ãƒƒã‚°
  imageFiles,   // çµ±åˆã™ã‚‹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
  {
    force: false,    // å¼·åˆ¶å®Ÿè¡Œãƒ•ãƒ©ã‚°
    mode: 'replace', // çµ±åˆãƒ¢ãƒ¼ãƒ‰
    backup: true     // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
  }
);
```

## ğŸ”„ çµ±åˆãƒ¢ãƒ¼ãƒ‰è©³ç´°

### 1. replace ãƒ¢ãƒ¼ãƒ‰
- **å‹•ä½œ**: æ—¢å­˜ç”»åƒã‚’å®Œå…¨ã«æ–°ç”»åƒã§ç½®æ›
- **ç”¨é€”**: ç”»åƒã‚’æ›´æ–°ã—ãŸã„å ´åˆ
- **å®‰å…¨æ€§**: é«˜ï¼ˆé‡è¤‡ãªã—ï¼‰
- **æ³¨æ„**: æ—¢å­˜ç”»åƒã¯å‰Šé™¤ã•ã‚Œã‚‹

### 2. skip ãƒ¢ãƒ¼ãƒ‰  
- **å‹•ä½œ**: çµ±åˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã€æ—¢å­˜ç”»åƒã‚’ä¿æŒ
- **ç”¨é€”**: æ—¢å­˜ç”»åƒã‚’ç¶­æŒã—ãŸã„å ´åˆ
- **å®‰å…¨æ€§**: æœ€é«˜ï¼ˆå¤‰æ›´ãªã—ï¼‰
- **æ³¨æ„**: æ–°ç”»åƒã¯çµ±åˆã•ã‚Œãªã„

### 3. merge ãƒ¢ãƒ¼ãƒ‰
- **å‹•ä½œ**: æ—¢å­˜ç”»åƒã‚’ä¿æŒã€æ–°ç”»åƒã‚’è¿½åŠ 
- **ç”¨é€”**: ä¸¡æ–¹ã®ç”»åƒã‚’ä¿æŒã—ãŸã„å ´åˆ
- **å®‰å…¨æ€§**: ä½ï¼ˆé‡è¤‡ãƒªã‚¹ã‚¯ï¼‰
- **æ³¨æ„**: é‡è¤‡è¡¨ç¤ºã®å¯èƒ½æ€§

## âš¡ ç·Šæ€¥æ™‚ã®å¯¾å¿œ

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©æ—§
```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
ls -la backups/

# æ‰‹å‹•å¾©æ—§ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
node scripts/restore-from-backup.js backups/article-xxx-timestamp.json
```

### é‡è¤‡ç”»åƒã®äº‹å¾Œä¿®æ­£
```bash
# é‡è¤‡æ¤œå‡º
node check-duplicate-images.js

# é‡è¤‡å‰Šé™¤
node remove-duplicate-images.js
```

## ğŸ“ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### å®Ÿè¡Œå‰ã®ç¢ºèªäº‹é …
1. âœ… Sanity Studio ã§è¨˜äº‹ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹
2. âœ… ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒæœŸå¾…ã•ã‚Œã‚‹å ´æ‰€ã«å­˜åœ¨ã™ã‚‹ã‹
3. âœ… é‡è¦ãªè¨˜äº‹ã®å ´åˆã¯äº‹å‰ã«æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

### æ¨å¥¨å®Ÿè¡Œæ‰‹é †
1. **é€šå¸¸å®Ÿè¡Œ**: `--force` ãƒ•ãƒ©ã‚°ãªã—ã§å®Ÿè¡Œ
2. **çŠ¶æ³ç¢ºèª**: æ—¢å­˜ç”»åƒã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª
3. **æ–¹é‡æ±ºå®š**: é©åˆ‡ãªçµ±åˆãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ
4. **çµæœç¢ºèª**: çµ±åˆå¾Œã«ãƒ–ãƒ©ã‚¦ã‚¶ã§è¡¨ç¤ºç¢ºèª
5. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†**: å®šæœŸçš„ãªå¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æ•´ç†

### æ³¨æ„äº‹é …
- ğŸš¨ `--force` ãƒ¢ãƒ¼ãƒ‰ã¯ç·Šæ€¥æ™‚ã®ã¿ä½¿ç”¨
- ğŸ’¾ é‡è¦ãªè¨˜äº‹ã¯äº‹å‰ã«Sanity Studio ã§æ‰‹å‹•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- ğŸ” çµ±åˆå¾Œã¯å¿…ãšãƒ–ãƒ©ã‚¦ã‚¶ã§è¡¨ç¤ºç¢ºèª
- ğŸ“ å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯å³åº§ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§

## ğŸ”§ é–‹ç™ºè€…å‘ã‘æƒ…å ±

### æ–°æ©Ÿèƒ½ã®è¿½åŠ 
```javascript
// ã‚«ã‚¹ã‚¿ãƒ çµ±åˆãƒ¢ãƒ¼ãƒ‰ã®è¿½åŠ ä¾‹
const customMode = {
  name: 'selective',
  description: 'headerç”»åƒã®ã¿ç½®æ›ã€sectionç”»åƒã¯ä¿æŒ',
  execute: async (uploadedImages, existingPost) => {
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
  }
};
```

### çµ±åˆå…ˆCMS ã®å¤‰æ›´
```javascript
// microCMSç­‰ã¸ã®å¯¾å¿œ
const cmsAdapter = {
  sanity: require('./adapters/sanity-adapter'),
  microcms: require('./adapters/microcms-adapter'),
  // ä»–ã®CMSå¯¾å¿œ
};
```

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆï¼š
1. å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª
2. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª  
3. `check-duplicate-images.js` ã§ç¾çŠ¶è¨ºæ–­
4. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•å¾©æ—§

**æ›´æ–°æ—¥**: 2025-07-16  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.0  
**å¯¾å¿œContentFlow**: v2.0+